<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PTS Report Card - Multi-Step</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Global Styles */
    body {
      margin: 0;
      padding: 1rem;
      font-family: "Roboto", sans-serif;
      background: #f9f9f9;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1, h2 {
      margin: 0.5rem 0;
    }
    .container {
      width: 100%;
      max-width: 600px;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    /* Top common section */
    .top-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    .top-section > div {
      flex: 1;
      min-width: 120px;
    }
    label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.3rem;
    }
    input[type="date"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 0.4rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .toggle-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-top: 0.5rem;
    }
    .toggle-group label {
      display: flex;
      align-items: center;
      gap: 0.2rem;
      cursor: pointer;
    }
    /* Subject card styling */
    .subject-card {
      display: none;
    }
    .subject-card.active {
      display: block;
    }
    .field-group {
      margin-bottom: 1rem;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }
    /* Navigation buttons */
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
    }
    button {
      cursor: pointer;
      background-color: #6200ee;
      color: #fff;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: 4px;
      font-size: 1rem;
    }
    button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
    /* Analytics section */
    .analytics {
      margin-top: 1rem;
      background: #e8f0fe;
      padding: 0.8rem;
      border-radius: 4px;
    }
    .analytics p {
      margin: 0.3rem 0;
    }
    /* Mobile friendly */
    @media (max-width: 480px) {
      .top-section {
        flex-direction: column;
      }
      .nav-buttons {
        flex-direction: column;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <h1>PTS Report Card</h1>
  <div class="container">
    <!-- Top common section: Report Date, Load Previous Data, Marking scheme -->
    <div class="top-section">
      <div>
        <label for="reportDate">Report Date</label>
        <input type="date" id="reportDate" />
      </div>
      <div>
        <label for="loadSelect">Load Saved Report</label>
        <select id="loadSelect">
          <option value="">--Select--</option>
        </select>
      </div>
      <div style="flex-basis:100%;">
        <label>Marks Per Question</label>
        <div class="toggle-group">
          <label><input type="radio" name="marksPerQ" value="2" checked />2</label>
          <label><input type="radio" name="marksPerQ" value="3" />3</label>
        </div>
      </div>
      <div style="flex-basis:100%;">
        <label>Negative Marking</label>
        <div class="toggle-group">
          <label><input type="radio" name="negative" value="0.5" />1/2</label>
          <label><input type="radio" name="negative" value="0.3333" />1/3</label>
          <label><input type="radio" name="negative" value="0.25" />1/4</label>
          <label><input type="radio" name="negative" value="0" checked />None</label>
        </div>
      </div>
      <div style="flex-basis:100%;">
        <button id="loadDataBtn">Load Report</button>
      </div>
    </div>
    
    <!-- Multi-Step Subject Section -->
    <div id="subjectContainer">
      <!-- Only one subject is shown at a time -->
      <div class="subject-card active" data-index="0">
        <h2 id="subjectTitle">Maths</h2>
        <div class="field-group">
          <label for="attempted">Attempted</label>
          <input type="number" id="attempted" min="0" value="0" />
        </div>
        <div class="field-group">
          <label for="correct">Correct</label>
          <input type="number" id="correct" min="0" value="0" />
        </div>
        <div class="field-group">
          <label for="incorrect">Incorrect (auto)</label>
          <input type="number" id="incorrect" value="0" readonly />
        </div>
        <div class="field-group">
          <label for="notes">Notes</label>
          <textarea id="notes" placeholder="Enter any notes here..."></textarea>
        </div>
      </div>
    </div>
    
    <!-- Navigation buttons -->
    <div class="nav-buttons">
      <button id="prevBtn" disabled>Previous</button>
      <button id="nextBtn">Next</button>
    </div>
    
    <!-- Final step: Save Data, Download PDF, and Analytics -->
    <div id="finalSection" style="display:none; margin-top:1rem;">
      <button id="saveDataBtn">Save Data</button>
      <button id="downloadPDFBtn" style="margin-left: 0.5rem;">Download as PDF</button>
      <div class="analytics" id="analytics">
        <!-- Analytics results will be injected here -->
      </div>
    </div>
  </div>
  
  <!-- Include html2canvas and jsPDF for PDF download -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Subjects (one per step)
    const subjects = ["Maths", "English", "GK/GS", "Reasoning"];
    let currentStep = 0;
    
    // Object to store each subject's data
    const subjectData = {};
    subjects.forEach(subj => {
      subjectData[subj] = { attempted: 0, correct: 0, notes: "" };
    });
    
    // Cache elements
    const subjectCard = document.querySelector(".subject-card");
    const subjectTitle = document.getElementById("subjectTitle");
    const attemptedInput = document.getElementById("attempted");
    const correctInput = document.getElementById("correct");
    const incorrectInput = document.getElementById("incorrect");
    const notesInput = document.getElementById("notes");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const finalSection = document.getElementById("finalSection");
    const analyticsDiv = document.getElementById("analytics");
    const loadSelect = document.getElementById("loadSelect");
    const loadDataBtn = document.getElementById("loadDataBtn");
    const reportDateInput = document.getElementById("reportDate");
    
    // Update auto-calculated "Incorrect"
    function updateAutoFields() {
      const attempted = parseInt(attemptedInput.value) || 0;
      const correct = parseInt(correctInput.value) || 0;
      const incorrect = attempted - correct;
      incorrectInput.value = incorrect >= 0 ? incorrect : 0;
    }
    
    // Save current subject data
    function saveCurrentSubject() {
      const subjName = subjects[currentStep];
      subjectData[subjName] = {
        attempted: parseInt(attemptedInput.value) || 0,
        correct: parseInt(correctInput.value) || 0,
        notes: notesInput.value || ""
      };
    }
    
    // Load current subject data into the form
    function loadCurrentSubject() {
      const subjName = subjects[currentStep];
      subjectTitle.textContent = subjName;
      const data = subjectData[subjName];
      attemptedInput.value = data.attempted;
      correctInput.value = data.correct;
      notesInput.value = data.notes;
      updateAutoFields();
    }
    
    // Update navigation buttons and final section visibility
    function updateNavigation() {
      prevBtn.disabled = currentStep === 0;
      if (currentStep === subjects.length - 1) {
        nextBtn.style.display = "none";
        finalSection.style.display = "block";
        showAnalytics();
      } else {
        nextBtn.style.display = "inline-block";
        finalSection.style.display = "none";
      }
    }
    
    // Calculate and display analytics for each subject
    function showAnalytics() {
      const marksPerQ = parseFloat(document.querySelector('input[name="marksPerQ"]:checked').value);
      const negativeMark = parseFloat(document.querySelector('input[name="negative"]:checked').value);
      analyticsDiv.innerHTML = "";
      subjects.forEach(subj => {
        const data = subjectData[subj];
        const incorrect = data.attempted - data.correct;
        const score = (data.correct * marksPerQ) - (incorrect * negativeMark);
        const p = document.createElement("p");
        p.textContent = `${subj}: Score = ${score.toFixed(2)}`;
        analyticsDiv.appendChild(p);
      });
    }
    
    // Populate the load dropdown from localStorage
    function loadSavedReports() {
      loadSelect.innerHTML = '<option value="">--Select--</option>';
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith("PTS_REPORT_")) {
          const option = document.createElement("option");
          option.value = key;
          option.textContent = key.replace("PTS_REPORT_", "");
          loadSelect.appendChild(option);
        }
      }
    }
    
    // Load saved data when "Load Report" is clicked
    loadDataBtn.addEventListener("click", () => {
      const key = loadSelect.value;
      if (!key) {
        alert("Please select a report to load.");
        return;
      }
      const savedData = JSON.parse(localStorage.getItem(key));
      if (savedData) {
        reportDateInput.value = savedData.date || "";
        // Set marking scheme
        document.querySelector(`input[name="marksPerQ"][value="${savedData.marksPerQ}"]`).checked = true;
        document.querySelector(`input[name="negative"][value="${savedData.negativeMark}"]`).checked = true;
        // Load subject data
        Object.keys(savedData.subjects).forEach(subj => {
          if (subjectData[subj] !== undefined) {
            subjectData[subj] = savedData.subjects[subj];
          }
        });
        currentStep = 0;
        loadCurrentSubject();
        updateNavigation();
        alert("Report loaded.");
      } else {
        alert("No data found for the selected report.");
      }
    });
    
    // Navigation event listeners
    nextBtn.addEventListener("click", () => {
      saveCurrentSubject();
      if (currentStep < subjects.length - 1) {
        currentStep++;
        loadCurrentSubject();
        updateNavigation();
      }
    });
    prevBtn.addEventListener("click", () => {
      saveCurrentSubject();
      if (currentStep > 0) {
        currentStep--;
        loadCurrentSubject();
        updateNavigation();
      }
    });
    
    // Save report to localStorage
    document.getElementById("saveDataBtn").addEventListener("click", () => {
      saveCurrentSubject(); // ensure current subject is saved
      const reportDate = reportDateInput.value;
      if (!reportDate) {
        alert("Please select a report date.");
        return;
      }
      const dataToSave = {
        date: reportDate,
        marksPerQ: document.querySelector('input[name="marksPerQ"]:checked').value,
        negativeMark: document.querySelector('input[name="negative"]:checked').value,
        subjects: subjectData
      };
      localStorage.setItem(`PTS_REPORT_${reportDate}`, JSON.stringify(dataToSave));
      alert("Report saved for " + reportDate);
      loadSavedReports();
    });
    
    // Download the report as PDF using html2canvas and jsPDF
    document.getElementById("downloadPDFBtn").addEventListener("click", () => {
      // Capture the container (including common top section and analytics)
      const container = document.querySelector(".container");
      html2canvas(container).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgProps = pdf.getImageProperties(imgData);
        const imgWidth = pdfWidth;
        const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        pdf.save("PTS_Report.pdf");
      });
    });
    
    // Update auto-calculated field on input changes
    attemptedInput.addEventListener("input", updateAutoFields);
    correctInput.addEventListener("input", updateAutoFields);
    
    // Initial load: load saved reports into dropdown
    loadSavedReports();
    loadCurrentSubject();
    updateNavigation();
  </script>
</body>
</html>
